<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/lodash-element/lodash.js.html">
<link rel="import" href="resource-list.html">

<dom-module id="resources-view">

    <template>

        <style>
            app-drawer {
                top: 50px;
                --app-drawer-content-container: {
                    background-color: #f3f3f3;
                };
            }

            .list {
                margin-left: 20px;
                margin-right: 20px;
                --paper-listbox-background-color: {
                    background-color: #f3f3f3;
                }
            }

            .list paper-item {
                --paper-item-focused-before: {
                    background-color: transparent;
                }
            }

            .list a {
                display: block;
                line-height: 40px;
                text-decoration: none;
                text-transform: uppercase;
                color: #7c7c7c;
            }

            .list a.active {
                color: black;
                font-weight: bold;
            }

            .badge-container {
                display: inline-block;
                margin-left: 30px;
                margin-right: 30px;
            }
            /* Need to position the badge to look like a text superscript */
            .badge-container > paper-badge {
                --paper-badge-margin-left: 20px;
                --paper-badge-margin-bottom: 0px;
            }
        </style>

        <iron-ajax url="../data/resources.json" auto last-response="{{items}}"></iron-ajax>
        <app-drawer-layout fullbleed>
            <app-drawer id="drawer" swipe-open>
                <paper-listbox class="list" selectedClass="active" selected-values="{{selectedCategories}}" multi>
                    <template is="dom-repeat" items="[[categories]]" as="category" initial-count="1">
                        <paper-item>
                            <a href="#" class="badge-container">
                                <span id$="[[category]]">[[category]]</span>
                                <paper-badge for$="[[category]]" label="[[_resourcesPerCategory(items, category)]]">
                                </paper-badge>
                                <paper-ripple></paper-ripple>
                            </a>
                        </paper-item>
                    </template>
                </paper-listbox>
            </app-drawer>
            <resource-list
                    section="category"
                    items="[[_getItemsCopy(items)]]"
                    featured-item="[[_getFeaturedItem(featuredItems, category)]]">
            </resource-list>
        </app-drawer-layout>

    </template>

    <script>

        Polymer({

            is: 'resources-view',

            behaviors: [Polymer.NeonAnimatableBehavior],

            properties: {
                animationConfig: {
                    value: function () {
                        return {
                            'entry': {
                                node: this,
                                name: 'fade-in-animation'
                            },
                            'exit': {
                                node: this,
                                name: 'fade-out-animation'
                            }
                        };
                    }
                },

                categories: {
                    type: Array,
                    computed: '_computeCategories(items)'
                },

                selectedCategories: {
                    type: Array,
                    value: function () {
                        return [0, 3];
                    }
                },

                category: {
                    type: String,
                    computed: '_computeSelectedCategory(categories, selectedCategoryIndex)'
                },

                items: {
                    type: Array
                },

                featuredItems: {
                    type: Array
                }
            },

            _getItemsCopy: function (items) {
                return items.slice();
            },

            _resourcesPerCategory: function (items, category) {
                return _.filter(_.flatten(_.map(items, 'categories')), function (item) {
                    return item === category;
                }).length;
            },

            _computeCategories: function (items) {
                return _.uniq(_.flatten(_.map(items, 'categories')));
            },

            _computeSelectedCategory: function (categories, index) {
                return categories[index];
            },

            _getFeaturedItem: function (featuredItems, category) {
                return featuredItems.filter(function (item) {
                    return item.category.toLowerCase() === category;
                }).pop();
            },

            _getSectionClass: function (index, selectedCategoryIndex) {
                return index === selectedCategoryIndex ? 'active' : '';
            }
        });

    </script>

</dom-module>
